<!DOCTYPE html>
<html>
<head>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
    <title>ETHER</title>
	<link rel="shortcut icon" type="image/x-icon" href="images/logo_ether_favicon.ico"/>
	<link rel="stylesheet" href="dojo-release-1.7.1/dijit/themes/claro/claro.css">
	<style>
		 html, body, #application, #applicationContainer {
			margin: 0px;
			padding: 0px;
			border: 0px;
			font-family: arial;
			overflow: hidden;
			width: 100%;
			height: 100%;
		}
		#chargement {
			margin: 100px auto;
			padding: 10px 30px;
			text-align: center;
			width: 100%;
			position: absolute;
		}
		#chargement #progressbar {
			width: 250px;
			margin: auto;
		}
		#connexion {
			text-align: center;
		}
		#connexion #tableauConnexion {
			margin: auto;
		}
		#applicationCenter {
			margin: 0px;
			padding: 0px;
			border: 0px;
		}
		#applicationBottom {
			height: 20%;
			width: 100%;
			margin: 0px;
			padding: 0px;
		}
		img.iconLoad {
			background-image: url("images/load.png");
			width: 24px;
			height: 24px;
		}
		img.iconSave {
			background-image: url("images/save.png");
			width: 24px;
			height: 24px;
		}
		img.iconLogout {
			background-image: url("images/logout.png");
			width: 24px;
			height: 24px;
		}
	</style>
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script src="dojo-release-1.7.1/dojo/dojo.js" data-dojo-config="parseOnLoad: false, isDebug: true"></script>
	<script>
		require(["dojo/parser", "dojo/on", "dojox/validate/web", "dojo/dom-construct", "dojo/_base/unload", "dojo/_base/sniff",
		"dijit/ProgressBar", "dijit/form/ValidationTextBox", "dijit/form/RadioButton", "dijit/form/Form", 
		"dijit/MenuBar", "dijit/PopupMenuBarItem", "dijit/DropDownMenu", "dijit/MenuItem", "ether/MenuItem", "dijit/MenuSeparator", "dijit/PopupMenuItem", "dijit/CheckedMenuItem",
		"dojox/form/Uploader", "dijit/form/Textarea", "dijit/form/FilteringSelect", "dojo/data/ItemFileReadStore",
		"dijit/layout/BorderContainer", "dijit/layout/ContentPane",
		"dojo/keys", "dojo/domReady!"], function(parser, on, validate, domConstruct, unload, has) {
		
console.log("mozilla : "+has("mozilla"));
console.log("firefox : "+has("ff"));
console.log("opera : "+has("opera"));
console.log("ie : "+has("ie"));
console.log("mac : "+has("mac"));
console.log("chrome : "+has("chrome"));
console.log("safari : "+has("safari"));
console.log("ios : "+has("ios"));
console.log("android : "+has("android"));
console.log("webkit : "+has("webkit"));
console.log("   test test   ");

			var TOUS = -1,
				ANIMATEURS = -2,
				NON_ANIMATEURS = -3;
			var maCle = -1;
			var moi = new participant('', '', false, 0); 
			var socket = io.connect(location.href);
			console.log(socket);
			var participants = new Array();
			participants[TOUS] = new participant('tous', '', undefined, undefined);
			participants[ANIMATEURS] = new participant('animateurs', '', true, undefined);
			participants[NON_ANIMATEURS] = new participant('non animateurs', '', false, undefined);
			// Allowed content types and extensions.
			var tailleMaxUpload = 2000000;
			var allowedTypes = {
				'image/png':       'png',
				'image/jpeg':      'jpg',
				'image/gif':       'gif',
				'image/bmp':       'bmp'
			};
			var allowedExtensions = []; // Array of allowed extensions.
			var contentTypes      = {}; // Reverse lookup of allowedTypes.
			for(ct in allowedTypes){
				allowedExtensions[allowedExtensions.length] = allowedTypes[ct];
				contentTypes[allowedTypes[ct]] = ct;
			}
			var testType = new RegExp('(\/uploads\/[0-9]+\.('+allowedExtensions.join('|')+'))$');

			changementPage("chargement", "connexion");
			parser.parse();
			new dijit.form.Textarea({ name: "menuEcrirePostit" }, "menuEcrirePostit");
			
			on(dijit.byId("boutonConnexion"), "click", function(event) {
				if(socket && socket.socket.connected) {	
					if(event.type=="click" || (event.type=="keyup" && event.keyCode==dojo.keys.ENTER)) {
						if(dijit.byId("formulaireConnexion").validate()) {
							var valeursEntrees = dijit.byId('formulaireConnexion').get('value');
							var estAnimateur = false;
							if(valeursEntrees.estAnimateur=="true")
								estAnimateur = true;
							moi = new participant(valeursEntrees.prenom, valeursEntrees.nom, estAnimateur, 0);
							socket.emit('identification', moi, valeursEntrees.motDePasse);
						}
					}
				} else {
					alert('Nous sommes désolés mais votre navigateur n\'est pas compatible avec ETHER.\nVous ne pouvez donc pas vous connecter.');
				}
			});
			
			dijit.byId("motDePasse").validator = function() {
				return (dijit.byId("participant").get("value") || dijit.byId("motDePasse").get("value")!="");
			}
			
			socket.on('identification echouee', function(msgErreur) {
				switch(msgErreur){
					case 'faux mdpEntre':
						dijit.byId("motDePasse").focus();
						dijit.byId("motDePasse").displayMessage("Le mot de passe entré est incorrect");
						break;
						
					case 'prenom':
						dijit.byId("prenom").validate();
						dijit.byId("prenom").focus();
						dijit.byId("prenom").displayMessage("Ce champ est obligatoire");
						break;
					  
					case 'nom':
						dijit.byId("nom").validate();
						dijit.byId("nom").focus();
						dijit.byId("nom").displayMessage("Ce champ est obligatoire");
						break;
					  
					case 'mdpEntre':
						dijit.byId("motDePasse").validate();
						dijit.byId("motDePasse").focus();
						dijit.byId("motDePasse").displayMessage("Le mot de passe est obligatoire pour les animateurs");
						break;
					  
					case 'login deja pris':
						dijit.byId("prenom").focus();
						dijit.byId("prenom").displayMessage("\""+dijit.byId("prenom").get("value")+" "+dijit.byId("nom").get("value")+"\" est déjà connecté(e) à Ether");
						break;
				}
			});
			
			function majParticipants() {
				var itemsParticipants = new Array();
				for(var i=0; i<participants.length; i++) {
					if(i!=maCle) {
						itemsParticipants.push({ value: 'participant_'+i, name: participants[i].prenom+' '+participants[i].nom });
					}
				}
				listeParticipants.clearOnClose = true;
				listeParticipants.data = { identifier: 'value', label: 'name', items: itemsParticipants };
				listeParticipants.close();
			}
			
			socket.on('identification reussie', function(liste_participants, key){
				if(moi.estAnimateur)
					dojo.byId("moi").innerHTML = moi.prenom+" "+moi.nom+"<br />(animateur)";
				else
					dojo.byId("moi").innerHTML = moi.prenom+" "+moi.nom;
				participants = liste_participants;
				maCle = key;
				majParticipants();
				changementPage("connexion", "application");
				dijit.byId("applicationContainer").resize();
			});
			
			function ajouterMessage(message, id_emetteur) {
				//à écrire en générant des post-it
			}
			
			socket.on('data decode response', function(message, id_emetteur){
				ajouterMessage(message, id_emetteur);
			});
			
			dijit.byId("menuChargement").onClick = function() {
				// on vérifie que le localStorage est supporté
				if(typeof(localStorage) == 'undefined' ) {
					alert('Impossible de charger la session car votre navigateur n\'est pas compatible.');
				} else {
					var t = new Array();
					for(var i = localStorage.length - 1 ; i >= 0 ; i--) {
						// on transforme la string enregistrée en tableau, sachant que le séparateur est |
						t = localStorage.getItem(localStorage.key(i)).split('|');
						var m = new msg('texte', 0, '');
						// si c'est l'identité de l'utilisateur courant
						if(t[0] == 'id') {
							if(t[1]!=moi.prenom || t[2]!=moi.nom || t[3]!=moi.estAnimateur) {
								//si la session chargée ne correspond pas au login actuel, on remplace la variable "moi"
								moi.prenom = t[1];
								moi.nom = t[2];
								moi.estAnimateur = t[3];
								//on actualise l'affichage
								if(moi.estAnimateur)
									dojo.byId("moi").innerHTML = moi.prenom+" "+moi.nom+"<br />(animateur)";
								else
									dojo.byId("moi").innerHTML = moi.prenom+" "+moi.nom;
								//et on informe le serveur du changement d'identité
								socket.emit('changement id', moi);
							}
						} else if(t[0] == 'texte') {
							//si c'est simplement un texte, on l'ajoute directement à l'interface utilisateur
							m.type = t[0];
							m.id = t[1];
							m.contenu = t[2];
							ajouterMessage(m, t[3]);
						} else {
							//si il s'agit d'une image (enregistrée en base 64), on l'envoie au serveur pour qu'il la stocke et la décode
							socket.emit('data decode request', t);
						}
					}
				}
			};
			
			socket.on('data encode response', function(data, ext) {
			/*
				//lorsque l'on reçoit une image encodée en base 64, on peut la sauvegarder en local
				m = ['image', $(el).attr('id'), data, $(el).children('span').text(), ext];
				// on utilise un try/catch au cas où on aurait plus de place
				try {
					// les infos pertinentes seront séparées par un | dans la string enregistrée
					localStorage.setItem('image' + index, m.join('|'));
				} catch(e) {
					if(e == QUOTA_EXCEEDED_ERR) {
						alert(
						'L\'espace de sauvegarde est plein. ' +
						'Vos ' + (index + 1) + ' images les plus récentes ont toutefois été enregistrées'
						);
					}
					console.log('erreur lors de l\'enregistrement de l\'image ' + index);
				}
			*/	
			});
						
			dijit.byId("menuSauvegarde").onClick = function() {
				// on vérifie que le localStorage est supporté
				if(typeof(localStorage) == 'undefined' ) {
					alert('Impossible de sauvegarder la session car votre navigateur n\'est pas compatible.');
				} else {
					// on commence par vider la base de données
					localStorage.clear();
					// on enregistre l'identité de l'utilisateur
					var p = new Array('id', moi.prenom, moi.nom, moi.estAnimateur);
					// on utilise un try/catch au cas où on aurait plus de place
					try {
						localStorage.setItem('id', p.join('|'));
					} catch(e) {
						if(e == QUOTA_EXCEEDED_ERR) {
							alert("Impossible d'enregistrer la session car l'espace de sauvegarde est plein.");
						}
						console.log('erreur lors de l\'enregistrement de l\'ID');
					}
					/*
					// on enregistre ensuite les messages texte du plus récent au plus ancien
					var m = new Array();
					//
					//il faut ici remplacer la boucle par une itération sur le tableau de David
					//
					$($('.texte').get().reverse()).each(function(index){
						m = ['texte', $(this).attr('id'), $(this).text(), $(this).children('span').text(), 'txt'];
						// on utilise un try/catch au cas où on aurait plus de place
						try {
							// les infos pertinentes seront séparées par un | dans la string enregistrée
							localStorage.setItem('texte' + index, m.join('|'));
						} catch(e) {
							if (e == QUOTA_EXCEEDED_ERR){
								//
								//si possible remplacer par un message du style les Nème photos les plus anciennes ne seront pas sauvegardées
								//
								alert(
								'L\'espace de sauvegarde est plein. ' +
								'Vos ' + (index + 1) + ' textes les plus récents ont toutefois été enregistrés'
								);
							}
							console.log('erreur lors de l\'enregistrement du texte ' + index);
						}
					});
					  
					// on enregistre ensuite les messages image du plus récent au plus ancien
					$($('.image').get().reverse()).each(function(index, el) {
						//pour stocker l'image dans la base de données sous forme de string, on demande au serveur de l'encoder en base 64
						socket.emit('data encode request', $(this).children('a').attr('href'));
					});
					*/
				}
			};
				  
			dijit.byId("menuDeconnexion").onClick = function() {
				if(confirm("Etes-vous sûr de vouloir vous déconnecter ?\n(Attention : toutes les données non sauvegardées seront perdues)")) {
					socket.disconnect();
					changementPage("application", "chargement");
					setTimeout("location.reload()", 2000);
				}
			}
			
			unload.addOnUnload(window, function(){ socket.disconnect(); });
			
			dijit.byId("menuAjouterPostit").onClick = function() {
				var texte = dijit.byId("menuEcrirePostit").get('value').replace(/\n/g,'<br />\n');
				if(texte!='') {
					dijit.byId("menuEcrirePostit").set('value', '');
					domConstruct.create("div", { innerHTML: texte }, dojo.byId("applicationCenter"));
				}
			}
			
			dijit.byId("uploadPhotos").onChange = function() {
				var files = dijit.byId("uploadPhotos")._files;
				if(files) {
					for (var i = 0; i < files.length; i++) {
						var reader = new FileReader();
						var nomUpload = files[i].name;
						var tailleUpload = files[i].size;
						reader.onloadstart = function() {
							dijit.showTooltip('Lecture du fichier ' + nomUpload, 'uploadPhotos', ['below']);
						};
						reader.onloadend = function() {
							dijit.showTooltip('<img src="images/upload.gif" /> Upload du fichier...', 'uploadPhotos', ['below']);
						};
						reader.onerror = function() {
							dijit.showTooltip('Erreur lors de la lecture du fichier ' + nomUpload, 'uploadPhotos', ['below']);
						};
						reader.onload = function(d) {
							dijit.showTooltip('Lecture de ' + nomUpload + 'réussie', 'uploadPhotos', ['below']);
							socket.emit('upload', nomUpload, d.target.result);
						};
						if(files[i].size < tailleMaxUpload) {
							reader.readAsDataURL(files[i]);
						}
						else {
							dijit.showTooltip('<img src="images/erreur.png" /> Impossible d\'uploader le fichier ' + nomUpload + ' qui est trop volumineux (taille maximale acceptée : 2Mo)', 'uploadPhotos', ['below']);
							setTimeout("dijit.hideTooltip('uploadPhotos')", 2000);
						}
					}
				} else {
					alert("Votre navigateur ne supporte pas l'upload");
				}
			};

			socket.on('upload reussi', function(nom, chemin) {
				dijit.showTooltip('<img src="images/ok.png" /> Upload de l\'image réussi !', 'uploadPhotos', ['below']);
				setTimeout("dijit.hideTooltip('uploadPhotos')", 2000);
				domConstruct.create("img", { src: chemin, alt: nom }, dojo.byId("applicationCenter"));
			});
			  
			socket.on('upload echoue', function() {
				dijit.showTooltip('<img src="images/erreur.png" /> Echec de l\'upload : le fichier n\'est pas une image ! (les extensions acceptées sont .png, .jpg et .gif)', 'uploadPhotos', ['below']);
				setTimeout("dijit.hideTooltip('uploadPhotos')", 2000);
			});	
			
			socket.on('connexion nouveau participant', function(participant, key) {
				participants[key] = participant;
				majParticipants();
			});
			  
			socket.on('deconnexion participant', function(key) {
				participants[key] = null;
				majParticipants();
			});
		});
		
		var dataParticipants = { identifier:'value', label:'name', items: [] };
		var listeParticipants = new dojo.data.ItemFileReadStore({ data: dataParticipants });
		
		function participant(prenom, nom, estAnimateur, socketID) {
			this.prenom = prenom;
			this.nom = nom;
			this.estAnimateur = estAnimateur;
			this.socketID = socketID;
		}

		function msg(type, id, contenu) {
			this.type = type;
			this.id = id;
			this.contenu = contenu;
		}
		
		function show(id) {
			dojo.setStyle(dojo.byId(id), { display: "" });
		}
		
		function hide(id) {
			dojo.setStyle(dojo.byId(id), { display: "none" });
		}
		
		function changementPage(anciennePage, nouvellePage) {
			dojo.fadeOut({
				node: anciennePage,
				duration: 1000,
				beforeBegin: function() {
					dojo.setStyle(dojo.byId(nouvellePage), { display: "", opacity: "0", filter: "alpha(opacity=0)" });
				},
				onEnd: function() {
					dojo.setStyle(dojo.byId(anciennePage), { display: "none" } );
					dojo.fadeIn({ node: nouvellePage, duration: 1000 }).play();
				}
			}).play();
		}
    </script>
</head>
<body class="claro">
	<div id="chargement">
		<div id="progressbar" data-dojo-type="dijit.ProgressBar" indeterminate="true"></div>
		<p>Veuillez patienter, chargement en cours...</p>
	</div>
	<div id="connexion" style="display: none;">
		<img src="images/logo_ether.png" alt="logo Ether"/>
		<h1>Connexion à ETHER</h1>
		<form id="formulaireConnexion" data-dojo-type="dijit.form.Form"> <!--method="post" onsubmit="return connexion(this);">-->
			<table id="tableauConnexion" cellspacing="4">
				<tr>
					<td colspan="2"><input type="text" required="true" name="prenom" id="prenom" placeholder="Votre prénom" data-dojo-type="dijit.form.ValidationTextBox" missingMessage="Ce champ est obligatoire" /></td>
				</tr>
				<tr>
					<td colspan="2"><input type="text" required="true" name="nom" id="nom" placeholder="Votre nom" data-dojo-type="dijit.form.ValidationTextBox" missingMessage="Ce champ est obligatoire" /></td>
				</tr>
				<tr>
					<td>
						<input type="radio" id="participant" name="estAnimateur" value="false" checked="checked" data-dojo-type="dijit.form.RadioButton" onclick="hide('champCache');" /> 
						<label for="participant">Participant</label>
					</td>
					<td>
						<input type="radio" id="animateur" name="estAnimateur" value="true" data-dojo-type="dijit.form.RadioButton" onclick="show('champCache');" />
						<label for="animateur">Animateur</label>
					</td>
				</tr>
				<tr id="champCache" style="display:none;">
					<td colspan="2"><input type="password" name="motDePasse" id="motDePasse" placeholder="Mot de passe" data-dojo-type="dijit.form.ValidationTextBox" invalidMessage="Le mot de passe est obligatoire pour les animateurs"/></td>
				</tr>
			</table>
			<input type="button" value="Se connecter" label="Se connecter" id="boutonConnexion" data-dojo-type="dijit.form.Button" />
		</form>
	</div>
	<div id="application" style="display: none;">
		<div data-dojo-type="dijit.MenuBar" id="navMenu">
			<div data-dojo-type="dijit.PopupMenuBarItem">
				<span>ETHER</span>
				<div data-dojo-type="dijit.DropDownMenu">
					<div data-dojo-type="ether.MenuItem">Connecté(e) en tant que :<br /><span id="moi"></span></div>
					<div data-dojo-type="dijit.MenuSeparator"></div>
					<div id="menuChargement" data-dojo-type="dijit.MenuItem" data-dojo-props="iconClass:'iconLoad'">Charger une session</div>
					<div id="menuSauvegarde" data-dojo-type="dijit.MenuItem" data-dojo-props="iconClass:'iconSave'">Sauvegarder la session</div>
					<div data-dojo-type="dijit.MenuSeparator"></div>
					<div id="menuDeconnexion" data-dojo-type="dijit.MenuItem" data-dojo-props="iconClass:'iconLogout'">Se déconnecter</div>
				</div>
			</div>
			<div data-dojo-type="dijit.PopupMenuBarItem">
				<span>Taper un texte</span>
				<div data-dojo-type="dijit.DropDownMenu">
					<div data-dojo-type="ether.MenuItem"><textarea id="menuEcrirePostit"></textarea></div>
					<div id="menuAjouterPostit" data-dojo-type="dijit.MenuItem">Ajouter à l'écran</div>
				</div>
			</div>
			<input id="uploadPhotos" name="uploadPhotos" multiple="true" type="file" data-dojo-type="dojox.form.Uploader" data-dojo-props="label:'Uploader une photo',uploadOnSelect:true" />
			<div data-dojo-type="dijit.Tooltip" data-dojo-props="connectId:'uploadPhotos',position:['below']"></div>
			<select id="selectionParticipants" name="selectionParticipants" data-dojo-type="dijit.form.FilteringSelect" data-dojo-props="store:listeParticipants,searchAttr:'name',required:false,value:'',placeHolder:'Ajouter un participant'"></select>
			<div data-dojo-type="dijit.PopupMenuBarItem">
				<span>Paramètres</span>
				<div data-dojo-type="dijit.DropDownMenu">
					<div data-dojo-type="dijit.PopupMenuItem">
						<span>1er paramètre</span>
						<div data-dojo-type="dijit.DropDownMenu">
							<div id="menuParametresCorbeille" data-dojo-type="dijit.CheckedMenuItem" data-dojo-props="checked:true">Afficher la corbeille</div>
							<div id="menuParametresATous" data-dojo-type="dijit.CheckedMenuItem" data-dojo-props="checked:true, disabled:true">Afficher l'envoi à tous</div>
							<div id="menuParametresAuxAnimateurs" data-dojo-type="dijit.CheckedMenuItem" data-dojo-props="checked:true, disabled:true">Afficher l'envoi aux animateurs</div>
							<div id="menuParametresAuxParticipants" data-dojo-type="dijit.CheckedMenuItem" data-dojo-props="checked:true, disabled:true">Afficher l'envoi aux participants</div>
						</div>
					</div>
					<div data-dojo-type="dijit.MenuItem" data-dojo-props="disabled:true">2ème paramètre</div>
					<div data-dojo-type="dijit.MenuItem" data-dojo-props="disabled:true">3ème paramètre</div>
				</div>
			</div>
		</div>
		<div id="applicationContainer" data-dojo-type="dijit.layout.BorderContainer">
			<div id="applicationCenter" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'"></div>
			<div id="applicationBottom" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'bottom'"></div>
		</div>
	</div>
</body>
</html>
