<!DOCTYPE html>
<html>
<head>
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
    <title>ETHER</title>
	<link rel="shortcut icon" type="image/x-icon" href="images/logo_ether_favicon.ico"/>
	<link rel="stylesheet" href="dojo-release-1.7.1/dijit/themes/claro/claro.css">
	<style>
		 html, body, #application, #applicationContainer {
			margin: 0px;
			padding: 0px;
			border: 0px;
			font-family: arial;
			overflow: hidden;
			width: 100%;
			height: 100%;
		}
		#chargement {
			margin: 100px auto;
			padding: 10px 30px;
			text-align: center;
			width: 100%;
			position: absolute;
		}
		#chargement #progressbar {
			width: 250px;
			margin: auto;
		}
		#connexion {
			text-align: center;
		}
		#connexion #tableauConnexion {
			margin: auto;
		}
		#applicationCenter {
			margin: 0px;
			padding: 0px;
			border: 0px;
		}
		#applicationBottom {
			height: 20%;
			width: 100%;
			margin: 0px;
			padding: 0px;
		}
		img.iconLoad {
			background-image: url("images/load.png");
			width: 24px;
			height: 24px;
		}
		img.iconSave {
			background-image: url("images/save.png");
			width: 24px;
			height: 24px;
		}
		img.iconLogout {
			background-image: url("images/logout.png");
			width: 24px;
			height: 24px;
		}
	</style>
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script src="dojo-release-1.7.1/dojo/dojo.js" data-dojo-config="parseOnLoad: false, isDebug: true"></script>
	<script>
		require(["dojo/parser", "dojo/on", "dojox/validate/web", "dojo/dom-construct",
		"dijit/ProgressBar", "dijit/form/ValidationTextBox", "dijit/form/RadioButton", "dijit/form/Form", 
		"dijit/MenuBar", "dijit/PopupMenuBarItem", "dijit/DropDownMenu", "dijit/MenuItem", "ether/MenuItem", "dijit/MenuSeparator", "dijit/PopupMenuItem", "dijit/CheckedMenuItem",
		"dojox/form/Uploader", "dijit/form/Textarea", "dijit/form/FilteringSelect", "dojo/data/ItemFileReadStore",
		"dijit/layout/BorderContainer", "dijit/layout/ContentPane",
		"dojo/keys", "dojo/domReady!"], function(parser, on, validate, domConstruct) {
		
			var TOUS = -1,
				ANIMATEURS = -2,
				NON_ANIMATEURS = -3;	
			var moi = new participant('', '', false, 0); 
			var socket = io.connect('http://localhost');
			var participants = new Array();
			participants[TOUS] = new participant('tous', '', undefined, undefined);
			participants[ANIMATEURS] = new participant('animateurs', '', true, undefined);
			participants[NON_ANIMATEURS] = new participant('non animateurs', '', false, undefined);
			// Allowed content types and extensions.
			var tailleMaxUpload = 2000000;
			var allowedTypes = {
				'image/png':       'png',
				'image/jpeg':      'jpg',
				'image/gif':       'gif',
				'image/bmp':       'bmp'
			};
			var allowedExtensions = []; // Array of allowed extensions.
			var contentTypes      = {}; // Reverse lookup of allowedTypes.
			for(ct in allowedTypes){
				allowedExtensions[allowedExtensions.length] = allowedTypes[ct];
				contentTypes[allowedTypes[ct]] = ct;
			}
			var testType = new RegExp('(\/uploads\/[0-9]+\.('+allowedExtensions.join('|')+'))$');

			changementPage("chargement", "connexion");
			parser.parse();
			new dijit.form.Textarea({ name: "menuEcrirePostit" }, "menuEcrirePostit");
			
			on(dijit.byId("boutonConnexion"), "click", function(event) {
				if(event.type=="click" || (event.type=="keyup" && event.keyCode==dojo.keys.ENTER)) {
					if(dijit.byId("formulaireConnexion").validate()) {
						var valeursEntrees = dijit.byId('formulaireConnexion').get('value');
						moi = new participant(valeursEntrees.prenom, valeursEntrees.nom, valeursEntrees.estAnimateur, 0);
						socket.emit('identification', moi, valeursEntrees.motDePasse);
					}
				}
			});
			
			dijit.byId("motDePasse").validator = function() {
				return (dijit.byId("participant").get("value") || dijit.byId("motDePasse").get("value")!="");
			}
			
			socket.on('identification echouee', function(msgErreur) {
				switch(msgErreur){
					case 'faux mdpEntre':
						dijit.byId("motDePasse").focus();
						dijit.byId("motDePasse").displayMessage("Le mot de passe entré est incorrect");
						break;
						
					case 'prenom':
						dijit.byId("prenom").validate();
						dijit.byId("prenom").focus();
						dijit.byId("prenom").displayMessage("Ce champ est obligatoire");
						break;
					  
					case 'nom':
						dijit.byId("nom").validate();
						dijit.byId("nom").focus();
						dijit.byId("nom").displayMessage("Ce champ est obligatoire");
						break;
					  
					case 'mdpEntre':
						dijit.byId("motDePasse").validate();
						dijit.byId("motDePasse").focus();
						dijit.byId("motDePasse").displayMessage("Le mot de passe est obligatoire pour les animateurs");
						break;
					  
					case 'login deja pris':
						dijit.byId("prenom").focus();
						dijit.byId("prenom").displayMessage("\""+dijit.byId("prenom").get("value")+" "+dijit.byId("nom").get("value")+"\" est déjà connecté(e) à Ether");
						break;
				}
			});
			 
			socket.on('identification reussie', function(liste_participants, key){
				if(moi.estAnimateur=="true")
					dojo.byId("moi").innerHTML = moi.prenom+" "+moi.nom+"<br />(animateur)";
				else
					dojo.byId("moi").innerHTML = moi.prenom+" "+moi.nom;
				participants = liste_participants;
				maCle = key;
				majParticipants();
				changementPage("connexion", "application");
				dijit.byId("applicationContainer").resize();
			});
			
			function majParticipants() {
				var itemsParticipants = new Array();
				for(var i=0; i<participants.length; i++) {
					if(i!=maCle) {
						itemsParticipants.push({ value: 'participant_'+i, name: participants[i].prenom+' '+participants[i].nom });
					}
				}
				listeParticipants.clearOnClose = true;
				listeParticipants.data = { identifier: 'value', label: 'name', items: itemsParticipants };
				listeParticipants.close();
			}
			
			dijit.byId("menuDeconnexion").onClick = function() {
				if(confirm("Etes-vous sûr de vouloir vous déconnecter ?")) {
					changementPage("application", "chargement");
					location.reload();
				}
			}
			
			dijit.byId("menuAjouterPostit").onClick = function() {
				var texte = dijit.byId("menuEcrirePostit").get('value').replace(/\n/g,'<br />\n');
				if(texte!='') {
					dijit.byId("menuEcrirePostit").set('value', '');
					domConstruct.create("div", { innerHTML: texte }, dojo.byId("applicationCenter"));
				}
			}
			
			dijit.byId("uploadPhotos").onChange = function() {
				var files = dijit.byId("uploadPhotos")._files;
				for (var i = 0; i < files.length; i++) {
					var reader = new FileReader();
					var nomUpload = files[i].name;
					var tailleUpload = files[i].size;
					reader.onloadstart = function() {
						dijit.showTooltip('Lecture du fichier ' + nomUpload, 'uploadPhotos', ['below']);
					};
					reader.onloadend = function() {
						dijit.showTooltip('<img src="images/upload.gif" /> Upload du fichier...', 'uploadPhotos', ['below']);
					};
					reader.onerror = function() {
						dijit.showTooltip('Erreur lors de la lecture du fichier ' + nomUpload, 'uploadPhotos', ['below']);
					};
					reader.onload = function(d) {
						dijit.showTooltip('Lecture de ' + nomUpload + 'réussie', 'uploadPhotos', ['below']);
						socket.emit('upload', nomUpload, d.target.result);
					};
					if(files[i].size < tailleMaxUpload) {
						reader.readAsDataURL(files[i]);
					}
					else {
						dijit.showTooltip('<img src="images/erreur.png" /> Impossible d\'uploader le fichier ' + nomUpload + ' qui est trop volumineux (taille maximale acceptée : 2Mo)', 'uploadPhotos', ['below']);
						setTimeout("dijit.hideTooltip('uploadPhotos')", 2000);
					}
				}
			};

			socket.on('upload reussi', function(chemin, numero, nom) {
				dijit.showTooltip('<img src="images/ok.png" /> Upload de l\'image réussi !', 'uploadPhotos', ['below']);
				setTimeout("dijit.hideTooltip('uploadPhotos')", 2000);
				domConstruct.create("img", { src: chemin, id:"photo_" + numero, alt: nom }, dojo.byId("applicationCenter"));
			});
			  
			socket.on('upload echoue', function() {
				dijit.showTooltip('<img src="images/erreur.png" /> Echec de l\'upload : le fichier n\'est pas une image ! (les extensions acceptées sont .png, .jpg et .gif)', 'uploadPhotos', ['below']);
				setTimeout("dijit.hideTooltip('uploadPhotos')", 2000);
			});	
			
			socket.on('connexion nouveau participant', function(participant, key) {
				participants[key] = participant;
				majParticipants();
			});
			  
			socket.on('deconnexion participant', function(key) {
				participants[maCle] = null;
				majParticipants();
			});
		});
		
		var dataParticipants = { identifier:'value', label:'name', items: [] };
		var listeParticipants = new dojo.data.ItemFileReadStore({ data: dataParticipants });
		
		function participant(prenom, nom, estAnimateur, socketID) {
			this.prenom = prenom;
			this.nom = nom;
			this.estAnimateur = estAnimateur;
			this.socketID = socketID;
		}

		function msg(type, id, contenu) {
			this.type = type;
			this.id = id;
			this.contenu = contenu;
		}
		
		function show(id) {
			dojo.setStyle(dojo.byId(id), { display: "" });
		}
		
		function hide(id) {
			dojo.setStyle(dojo.byId(id), { display: "none" });
		}
		
		function changementPage(anciennePage, nouvellePage) {
			dojo.fadeOut({
				node: anciennePage,
				duration: 1000,
				beforeBegin: function() {
					dojo.setStyle(dojo.byId(nouvellePage), { display: "", opacity: "0", filter: "alpha(opacity=0)" });
				},
				onEnd: function() {
					dojo.setStyle(dojo.byId(anciennePage), { display: "none" } );
					dojo.fadeIn({ node: nouvellePage, duration: 1000 }).play();
				}
			}).play();
		}
    </script>
</head>
<body class="claro">
	<div id="chargement">
		<div id="progressbar" data-dojo-type="dijit.ProgressBar" indeterminate="true"></div>
		<p>Veuillez patienter, chargement en cours...</p>
	</div>
	<div id="connexion" style="display: none;">
		<img src="images/logo_ether.png" alt="logo Ether"/>
		<h1>Connexion à ETHER</h1>
		<form id="formulaireConnexion" data-dojo-type="dijit.form.Form"> <!--method="post" onsubmit="return connexion(this);">-->
			<table id="tableauConnexion" cellspacing="4">
				<tr>
					<td colspan="2"><input type="text" required="true" name="prenom" id="prenom" placeholder="Votre prénom" data-dojo-type="dijit.form.ValidationTextBox" missingMessage="Ce champ est obligatoire" /></td>
				</tr>
				<tr>
					<td colspan="2"><input type="text" required="true" name="nom" id="nom" placeholder="Votre nom" data-dojo-type="dijit.form.ValidationTextBox" missingMessage="Ce champ est obligatoire" /></td>
				</tr>
				<tr>
					<td>
						<input type="radio" id="participant" name="estAnimateur" value="false" checked="checked" data-dojo-type="dijit.form.RadioButton" onclick="hide('champCache');" /> 
						<label for="participant">Participant</label>
					</td>
					<td>
						<input type="radio" id="animateur" name="estAnimateur" value="true" data-dojo-type="dijit.form.RadioButton" onclick="show('champCache');" />
						<label for="animateur">Animateur</label>
					</td>
				</tr>
				<tr id="champCache" style="display:none;">
					<td colspan="2"><input type="password" name="motDePasse" id="motDePasse" placeholder="Mot de passe" data-dojo-type="dijit.form.ValidationTextBox" invalidMessage="Le mot de passe est obligatoire pour les animateurs"/></td>
				</tr>
			</table>
			<input type="button" value="Se connecter" label="Se connecter" id="boutonConnexion" data-dojo-type="dijit.form.Button" />
		</form>
	</div>
	<div id="application" style="display: none;">
		<div data-dojo-type="dijit.MenuBar" id="navMenu">
			<div data-dojo-type="dijit.PopupMenuBarItem">
				<span>ETHER</span>
				<div data-dojo-type="dijit.DropDownMenu">
					<div data-dojo-type="ether.MenuItem">Connecté(e) en tant que :<br /><span id="moi"></span></div>
					<div data-dojo-type="dijit.MenuSeparator"></div>
					<div id="menuChargement" data-dojo-type="dijit.MenuItem" data-dojo-props="iconClass:'iconLoad', disabled:true">Charger une session</div>
					<div id="menuSauvegarde" data-dojo-type="dijit.MenuItem" data-dojo-props="iconClass:'iconSave', disabled:true">Sauvegarder la session</div>
					<div data-dojo-type="dijit.MenuSeparator"></div>
					<div id="menuDeconnexion" data-dojo-type="dijit.MenuItem" data-dojo-props="iconClass:'iconLogout'">Se déconnecter</div>
				</div>
			</div>
			<div data-dojo-type="dijit.PopupMenuBarItem">
				<span>Taper un texte</span>
				<div data-dojo-type="dijit.DropDownMenu">
					<div data-dojo-type="ether.MenuItem"><textarea id="menuEcrirePostit"></textarea></div>
					<div id="menuAjouterPostit" data-dojo-type="dijit.MenuItem">Ajouter à l'écran</div>
				</div>
			</div>
			<input id="uploadPhotos" name="uploadPhotos" multiple="true" type="file" data-dojo-type="dojox.form.Uploader" data-dojo-props="label:'Uploader une photo',uploadOnSelect:true" />
			<div data-dojo-type="dijit.Tooltip" data-dojo-props="connectId:'uploadPhotos',position:['below']"></div>
			<select id="selectionParticipants" name="selectionParticipants" data-dojo-type="dijit.form.FilteringSelect" data-dojo-props="store:listeParticipants,searchAttr:'name',required:false,value:'',placeHolder:'Ajouter un participant'"></select>
			<div data-dojo-type="dijit.PopupMenuBarItem">
				<span>Paramètres</span>
				<div data-dojo-type="dijit.DropDownMenu">
					<div data-dojo-type="dijit.PopupMenuItem">
						<span>1er paramètre</span>
						<div data-dojo-type="dijit.DropDownMenu">
							<div id="menuParametresCorbeille" data-dojo-type="dijit.CheckedMenuItem" data-dojo-props="checked:true">Afficher la corbeille</div>
							<div id="menuParametresATous" data-dojo-type="dijit.CheckedMenuItem" data-dojo-props="checked:true, disabled:true">Afficher l'envoi à tous</div>
							<div id="menuParametresAuxAnimateurs" data-dojo-type="dijit.CheckedMenuItem" data-dojo-props="checked:true, disabled:true">Afficher l'envoi aux animateurs</div>
						</div>
					</div>
					<div data-dojo-type="dijit.MenuItem" data-dojo-props="disabled:true">2ème paramètre</div>
					<div data-dojo-type="dijit.MenuItem" data-dojo-props="disabled:true">3ème paramètre</div>
				</div>
			</div>
		</div>
		<div id="applicationContainer" data-dojo-type="dijit.layout.BorderContainer">
			<div id="applicationCenter" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'"></div>
			<div id="applicationBottom" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'bottom'"></div>
		</div>
	</div>
</body>
</html>
